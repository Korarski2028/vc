#  to get nvme datasrores and paths 
####################################################################
# Connect to vCenter
Connect-VIServer -Server your_vcenter_server

$clusterName = "xxxxxxxxxxx"
$cluster = Get-Cluster -Name $clusterName

# HBAs of interest (NVMe over TCP adapters)
$targetHBAs = @("vmhba64", "vmhba65")

$results = @()

foreach ($host in Get-VMHost -Location $cluster) {
    # Get the HBAs matching vmhba64 and vmhba65
    $hbas = Get-VMHostHba -VMHost $host | Where-Object { $targetHBAs -contains $_.Device }

    foreach ($hba in $hbas) {
        # Get all disk LUNs on this HBA
        $luns = Get-ScsiLun -VMHost $host -Hba $hba -LunType disk

        foreach ($lun in $luns) {
            # Get datastore(s) using this LUN (if any)
            $datastores = Get-Datastore -VMHost $host | Where-Object {
                $_.ExtensionData.Info.Vmfs.Extent | Where-Object { $_.DiskName -eq $lun.CanonicalName }
            } | Select-Object -ExpandProperty Name

            $dsName = if ($datastores) { $datastores -join "," } else { "N/A" }

            # Get all paths for this LUN
            $paths = Get-ScsiLunPath -ScsiLun $lun

            # Count active paths on this HBA
            $activePathsOnHba = ($paths | Where-Object { $_.State -eq "active" -and $_.HbaName -eq $hba.Device }).Count

            # Transport type from the lun (e.g., NVMe/TCP)
            $transport = $lun.Transport

            $results += [PSCustomObject]@{
                HostName        = $host.Name
                HBAName         = $hba.Device
                LUNCanonical    = $lun.CanonicalName
                DatastoreName   = $dsName
                LunType         = $lun.LunType
                Transport       = $transport
                ActivePathCount = $activePathsOnHba
            }
        }
    }
}

# Output the results
$results | Format-Table -AutoSize

# Optionally export to CSV
#$results | Export-Csv -Path "NVMeTCP_Devices_Report.csv" -NoTypeInformation

# Disconnect from vCenter
Disconnect-VIServer -Confirm:$false
