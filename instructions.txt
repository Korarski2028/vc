#  to get nvme datasrores and paths 
####################################################################
$cluster #read from file 
$vhost #read from file vC NAME

# Connect to vCenter
Connect-VIServer -Server $vhost -Credentials $creds

# Define clusters of interest
$clusters = @("Cluster-A", "Cluster-B")

# Output array
$report = @()


foreach ($clusterName in $clusters) {
   # $cluster = Get-Cluster -Name $clusterName
    $hosts = Get-VMHost -Location $cluster

    foreach ($host in $hosts) {
        Write-Host "Processing host: $($host.Name)"

        # Get host storage system view
        $hostView = Get-View -Id $host.Id
        $storageSys = Get-View $hostView.ConfigManager.StorageSystem

        # Refresh storage info (optional but good to ensure up-to-date path info)
        # $storageSys.RefreshStorageSystem()

        # Get all disk-type LUNs
        $scsiLuns = Get-ScsiLun -VmHost $host -LunType disk | Where-Object {
            $_.CanonicalName -like "naa.*"
        }

        foreach ($lun in $scsiLuns) {
            # Get paths
            $paths = Get-ScsiLunPath -ScsiLun $lun

            # Try to extract transport type via extensions or description
            $transType = $lun.ExtensionData.Transport

            # Some ESXi versions expose "nvme-tcp" in DisplayName or Vendor
            $nvmeTCPMatch = ($lun.Model -match "nvme" -and $lun.Vendor -match "tcp") -or
                            ($transType -match "nvme") -or
                            ($lun.DisplayName -match "nvme.*tcp")

            if ($nvmeTCPMatch) {
                # Try to resolve datastore name from LUN (can be multiple)
                $datastore = ($lun | Get-Datastore | Select-Object -First 1).Name

                $report += [PSCustomObject]@{
                    Host         = $host.Name
                    Datastore    = $datastore
                    CanonicalLUN = $lun.CanonicalName
                    NumPaths     = $paths.Count
                    Multipath    = $lun.MultipathPolicy
                    Transport    = $transType
                    Vendor       = $lun.Vendor
                    Model        = $lun.Model
                }
            }
        }
    }
}

# Export to CSV
$report | Export-Csv -Path "C:\Temp\nvme_tcp_datastores.csv" -NoTypeInformation

Write-Host "Report saved to C:\Temp\nvme_tcp_datastores.csv"

# Disconnect session
Disconnect-VIServer -Confirm:$false